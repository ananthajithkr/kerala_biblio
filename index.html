<!-- 
Created by Ananthajith KR at stet dot in
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Urava Biblio</title>

  <!-- Tabulator CSS -->
  <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet"/>

  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
    }
    #search {
      margin-bottom: 1rem;
      width: 300px;
      padding: 0.5rem;
    }
    .tabulator .tabulator-row .tabulator-cell {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>
</head>
<body>

  <h1>Search Urava</h1>
  <input type="text" id="search" placeholder="Search...">
  <div id="zotero-table"></div>

  <!-- Tabulator Core + Export Module -->
  <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
  <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/modules/export.min.js"></script>
  <!-- Fuse.js for fuzzy search -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

  <script>
    fetch('zotero_items.json')
      .then(res => res.json())
      .then(data => {
        // Initialize Tabulator
        const table = new Tabulator("#zotero-table", {
          data: data,
          layout: "fitColumns",
          pagination: "local",
          paginationSize: 20,
          placeholder: "No Data Found",
          columns: [
            {title: "Title", field: "data.title", headerFilter: "input"},
            {title: "Author", field: "data.creators[0].lastName", headerFilter: "input"},
            {title: "Date", field: "data.date"},
            {title: "Type", field: "data.itemType"},
            {title: "Publication", field: "data.publicationTitle"},
            {
              title: "Details",
              formatter: "responsiveCollapse",
              width: 30,
              hozAlign: "center",
              resizable: false,
              headerSort: false
            }
          ],
          responsiveLayout: "collapse",
          rowFormatter: function(row) {
            const data = row.getData();
            const container = document.createElement("div");
            container.innerHTML = `
              <strong>Full Data:</strong>
              <pre style="white-space: pre-wrap;">${JSON.stringify(data, null, 2)}</pre>
            `;
            row.getElement().appendChild(container);
          }
        });

        // Fuse.js Fuzzy Search Setup
        const fuse = new Fuse(data, {
          keys: ["data.title", "data.creators[0].lastName", "data.publicationTitle"],
          threshold: 0.4
        });

        document.getElementById("search").addEventListener("input", (e) => {
          const query = e.target.value;
          if (query) {
            const result = fuse.search(query).map(r => r.item);
            table.setData(result);
          } else {
            table.setData(data);
          }
        });

        // Global export buttons
        const exportDiv = document.createElement("div");
        exportDiv.innerHTML = `
          <button onclick="table.download('csv', 'zotero.csv')">CSV</button>
          <button onclick="table.download('json', 'zotero.json')">JSON</button>
          <button onclick="table.download('xlsx', 'zotero.xlsx')">Excel</button>
          <button onclick="table.download('pdf', 'zotero.pdf', {
            orientation:'portrait',
            title:'Zotero Items',
          })">PDF</button>
        `;
        document.body.insertBefore(exportDiv, document.getElementById("zotero-table"));
      });
  </script>
</body>
</html>
