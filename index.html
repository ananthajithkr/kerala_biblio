<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Urava Frontend</title>

  <!-- Tabulator CSS -->
  <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet" />

  <!-- Tabulator JS -->
  <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>

  <!-- Fuse.js for fuzzy search -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

  <!-- FileSaver for export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  
  <!-- Created by Ananthajith KR at stet dot in -->
  
  <style>
    body {
      font-family: sans-serif;
      margin: 2em;
    }
    #search {
      margin-bottom: 1em;
      width: 100%;
      max-width: 400px;
      padding: 0.5em;
      font-size: 1em;
    }
    .json-detail {
      font-family: monospace;
      white-space: pre-wrap;
      font-size: 0.9em;
      background: #f6f8fa;
      border-left: 3px solid #ccc;
      padding: 1em;
      margin-top: 0.5em;
    }
  </style>
</head>
<body>

  <h1>Urava Search</h1>
  <input type="text" id="search" placeholder="Fuzzy search..." />

  <div id="zotero-table"></div>

  <script>
    fetch("zotero_items.json")
      .then(response => response.json())
      .then(data => {
        const tableData = data.map(item => {
          const d = item.data || {};

          let authors = "—";
          if (d.creators && Array.isArray(d.creators)) {
            const names = d.creators.map(c => {
              if (c.name) {
                return c.name;
              } else if (c.lastName || c.firstName) {
                return `${c.lastName || ""}, ${c.firstName || ""}`.trim().replace(/^,|,$/g, '');
              }
              return null;
            }).filter(Boolean);
            if (names.length > 0) {
              authors = names.join("; ");
            }
          }

          return {
            id: item.key,
            author: authors,
            title: d.title || "—",
            date: d.date || "—",
            type: d.itemType || "—",
            publication: d.publicationTitle || d.bookTitle || d.websiteTitle || "—",
            full: d,
          };
        });

        const fuse = new Fuse(tableData, {
          keys: ["author", "title", "type", "publication"],
          threshold: 0.3,
        });

        const table = new Tabulator("#zotero-table", {
          data: tableData,
          layout: "fitColumns",
          pagination: "local",
          paginationSize: 10,
          columns: [
            { title: "Author", field: "author" },
            { title: "Title", field: "title", widthGrow: 2 },
            { title: "Date", field: "date", hozAlign: "center" },
            { title: "Type", field: "type" },
            { title: "Publication", field: "publication" },
            {
              title: "Details",
              formatter: () => "➕",
              hozAlign: "center",
              cellClick: function (e, cell) {
  const row = cell.getRow();
  const already = row.getElement().nextElementSibling;

  if (already && already.classList.contains("json-detail")) {
    already.remove();
  } else {
    const data = row.getData().full;
    const detail = document.createElement("div");
    detail.className = "json-detail";
    detail.style.background = "#f9f9f9";
    detail.style.border = "1px solid #ccc";
    detail.style.padding = "10px";
    detail.style.margin = "10px 0";
    detail.innerHTML = `
      <strong>Abstract:</strong> ${data.abstractNote || '—'}<br/>
      <strong>URL:</strong> ${data.url ? `<a href="${data.url}" target="_blank">${data.url}</a>` : '—'}<br/>
      <strong>Tags:</strong> ${(data.tags || []).map(tag => tag.tag).join(', ') || '—'}<br/>
      <strong>DOI:</strong> ${data.DOI || '—'}<br/>
      <strong>Extra:</strong> ${data.extra || '—'}
    `;

    row.getElement().after(detail);
  }
}
              }
            }
          ],
        });

        document.getElementById("search").addEventListener("input", (e) => {
          const query = e.target.value.trim();
          if (!query) {
            table.setData(tableData);
          } else {
            const results = fuse.search(query).map(r => r.item);
            table.setData(results);
          }
        });

        // Export buttons
        const exportDiv = document.createElement("div");
        exportDiv.innerHTML = `
          <button onclick="table.download('csv', 'zotero.csv')">Export CSV</button>
          <button onclick="table.download('json', 'zotero.json')">Export JSON</button>
          <button onclick="table.download('xlsx', 'zotero.xlsx', {sheetName:'Zotero'})">Export Excel</button>
        `;
        document.body.insertBefore(exportDiv, document.getElementById("zotero-table"));
      });
  </script>

</body>
</html>
