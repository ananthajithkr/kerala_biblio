<!-- 
Created by Ananthajith KR at stet dot in
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Zotero Viewer</title>

  <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet"/>

  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
    }
    #search {
      margin-bottom: 1rem;
      width: 300px;
      padding: 0.5rem;
    }
    .tabulator .tabulator-row .tabulator-cell {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .details-box {
      padding: 1em;
      background: #f9f9f9;
      border-top: 1px solid #ddd;
      font-size: 0.9rem;
      line-height: 1.5;
    }
    .details-box strong {
      display: inline-block;
      min-width: 120px;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h1>Zotero Items</h1>
  <input type="text" id="search" placeholder="Search...">
  <div id="zotero-table"></div>

  <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
  <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/modules/export.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

  <script>
    fetch('zotero_items.json')
      .then(res => res.json())
      .then(data => {
        const table = new Tabulator("#zotero-table", {
          data: data,
          layout: "fitColumns",
          pagination: "local",
          paginationSize: 20,
          placeholder: "No Data Found",
          responsiveLayout: "collapse",
          columns: [
            {title: "Title", field: "data.title", headerFilter: "input"},
            {title: "Author", field: "data.creators[0].lastName", headerFilter: "input"},
            {title: "Date", field: "data.date"},
            {title: "Type", field: "data.itemType"},
            {title: "Publication", field: "data.publicationTitle"},
            {
              formatter: "responsiveCollapse",
              width: 30,
              hozAlign: "center",
              resizable: false,
              headerSort: false
            }
          ],
          responsiveLayoutCollapseFormatter: function(data) {
            const fields = data.data;
            const creators = fields.creators?.map(c => `${c.firstName || ''} ${c.lastName || ''}`).join(", ") || 'N/A';

            return `
              <div class="details-box">
                <div><strong>Title:</strong> ${fields.title || '—'}</div>
                <div><strong>Author(s):</strong> ${creators}</div>
                <div><strong>Date:</strong> ${fields.date || '—'}</div>
                <div><strong>Type:</strong> ${fields.itemType || '—'}</div>
                <div><strong>Publication:</strong> ${fields.publicationTitle || '—'}</div>
                <div><strong>URL:</strong> ${fields.url ? `<a href="${fields.url}" target="_blank">${fields.url}</a>` : '—'}</div>
                <div><strong>DOI:</strong> ${fields.DOI || '—'}</div>
                <div><strong>Abstract:</strong> ${fields.abstractNote || '—'}</div>
              </div>
            `;
          }
        });

        // Fuzzy search
        const fuse = new Fuse(data, {
          keys: ["data.title", "data.creators[0].lastName", "data.publicationTitle"],
          threshold: 0.4
        });

        document.getElementById("search").addEventListener("input", (e) => {
          const query = e.target.value;
          table.setData(query ? fuse.search(query).map(r => r.item) : data);
        });

        // Export buttons
        const exportDiv = document.createElement("div");
        exportDiv.innerHTML = `
          <button onclick="table.download('csv', 'zotero.csv')">CSV</button>
          <button onclick="table.download('json', 'zotero.json')">JSON</button>
          <button onclick="table.download('xlsx', 'zotero.xlsx')">Excel</button>
          <button onclick="table.download('pdf', 'zotero.pdf', {
            orientation:'portrait',
            title:'Zotero Items',
          })">PDF</button>
        `;
        document.body.insertBefore(exportDiv, document.getElementById("zotero-table"));
      });
  </script>
</body>
</html>
