<!-- 
Created by Ananthajith KR at stet dot in
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Zotero Items</title>

  <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet"/>
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
    }
    #search {
      margin-bottom: 1rem;
      padding: 0.5rem;
      width: 300px;
    }
    .tabulator .tabulator-row .tabulator-cell {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .details-box {
      padding: 1rem;
      background: #f9f9f9;
      border-top: 1px solid #ddd;
      font-size: 0.9rem;
    }
    .details-box div {
      margin-bottom: 0.3em;
    }
    .details-box strong {
      display: inline-block;
      min-width: 120px;
    }
  </style>
</head>
<body>

  <h1>Zotero Items</h1>
  <input type="text" id="search" placeholder="Search...">
  <div id="zotero-table"></div>

  <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
  <script src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/modules/export.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

  <script>
    fetch("zotero_items.json")
      .then(res => res.json())
      .then(data => {
        const table = new Tabulator("#zotero-table", {
          data: data,
          layout: "fitColumns",
          pagination: "local",
          paginationSize: 20,
          columns: [
            {
              formatter: function () {
                return "<button>+</button>";
              },
              width: 40,
              hozAlign: "center",
              cellClick: function (e, cell) {
                const row = cell.getRow();
                row.getElement().classList.toggle("expanded");

                if (row.getElement().nextSibling?.classList.contains("details-box")) {
                  row.getElement().nextSibling.remove(); // remove if already there
                } else {
                  const data = row.getData().data;
                  const creators = (data.creators || []).map(c => `${c.firstName || ""} ${c.lastName || ""}`).join(", ");
                  const details = document.createElement("div");
                  details.className = "details-box";
                  details.innerHTML = `
                    <div><strong>Title:</strong> ${data.title || '—'}</div>
                    <div><strong>Author(s):</strong> ${creators || '—'}</div>
                    <div><strong>Date:</strong> ${data.date || '—'}</div>
                    <div><strong>Type:</strong> ${data.itemType || '—'}</div>
                    <div><strong>Publication:</strong> ${data.publicationTitle || '—'}</div>
                    <div><strong>URL:</strong> ${data.url ? `<a href="${data.url}" target="_blank">${data.url}</a>` : '—'}</div>
                    <div><strong>DOI:</strong> ${data.DOI || '—'}</div>
                    <div><strong>Abstract:</strong> ${data.abstractNote || '—'}</div>
                  `;
                  row.getElement().after(details);
                }
              }
            },
            {title: "Title", field: "data.title"},
            {title: "Author", field: "data.creators[0].lastName"},
            {title: "Date", field: "data.date"},
            {title: "Type", field: "data.itemType"},
            {title: "Publication", field: "data.publicationTitle"},
          ]
        });

        // Fuzzy search
        const fuse = new Fuse(data, {
          keys: ["data.title", "data.creators[0].lastName", "data.publicationTitle"],
          threshold: 0.4
        });

        document.getElementById("search").addEventListener("input", (e) => {
          const query = e.target.value;
          table.setData(query ? fuse.search(query).map(r => r.item) : data);
        });

        // Export buttons
        const exportDiv = document.createElement("div");
        exportDiv.innerHTML = `
          <button onclick="table.download('csv', 'zotero.csv')">Export CSV</button>
          <button onclick="table.download('json', 'zotero.json')">Export JSON</button>
          <button onclick="table.download('xlsx', 'zotero.xlsx')">Export Excel</button>
          <button onclick="table.download('pdf', 'zotero.pdf', {orientation:'portrait', title:'Zotero Items'})">Export PDF</button>
        `;
        document.body.insertBefore(exportDiv, document.getElementById("zotero-table"));
      });
  </script>
</body>
</html>
